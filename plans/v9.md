# V9 Breaking Changes Implementation Plan

## Phase 0: Assess and Streamline - Remove Complex jsforce Wrappers

### Components to REMOVE (Complex jsforce Wrappers)

- **ExecuteService** (`src/execute/`) - Custom SOAP implementation for execute anonymous
  - jsforce already provides `conn.tooling.executeAnonymous()` REST API method
  - Current implementation uses complex SOAP envelope building (`encodeBody`, SOAP parsing)
  - Migration: Document how to use `jsforce.tooling.executeAnonymous()` directly
- **Basic Tooling API Wrappers** in TestService
  - Simple `connection.tooling.query()` and `connection.tooling.create()` calls
  - These add no value over direct jsforce usage
- **Simple Auth Refresh** (`src/utils/authUtil.ts`)
  - `refreshAuth()` function is just a basic connection.request() call
  - Core already handles auth refresh automatically
- **Reduce extension use** modify the extension code to not use the library for its wrappers (dogfooding!)

### Components to KEEP (Unique Value-Add)

- **Test Result Processing & Formatting** - Complex business logic jsforce doesn't handle:
  - Test result aggregation and transformation
  - Multiple output formats (JSON, TAP, JUnit, Human-readable)
  - Code coverage calculation and reporting
  - Test payload building with namespace handling
- **TraceFlag Management** - Complex multi-step workflow jsforce doesn't provide:
  - Debug level creation/update logic
  - Trace flag lifecycle management
  - Expiration date calculation
  - BUT it also duplicates a bunch of what's in the extensions!
- **Reporters** - Specialized formatting that's library-specific:
  - HumanReporter, TapReporter, JUnitReporter, CoverageReporter
  - These provide significant value-add over raw data

### jsforce Gaps to Address (Priority Order)

1. **RelevantTest Level Support** - Add support for new `RelevantTest` test level in jsforce types and implementation

## Phase 1: API Audit & Cleanup (MOVED TO BEGINNING)

- **Conduct thorough method and export audit FIRST**
- **Verify all exports are used by plugin-apex, mcp, or vsce**
- **Remove unused exports and methods BEFORE other work**
- **Identify dead code and unused options to avoid unnecessary migration work**
- **Document what's actually being used vs what exists**

## Phase 2: Foundation Updates

- wanna go ESM?  CLI would have no problem, extensions 
- Update minimum Node version to 20 in `package.json` engines field
- Upgrade TypeScript config to 2023 standards in `tsconfig.json`
- Upgrade to ESLint 9 with standard CLI library rules and fix all linting issues

## Phase 3: Remove jsforce Wrappers

- **Remove ExecuteService entirely** - Replace with migration docs showing jsforce usage
- **Simplify TestService** - Remove basic tooling.query/create wrappers, keep complex logic
- **Remove authUtil.refreshAuth** - Core handles this automatically
- **Update exports** - Remove ExecuteService and related types from main index

## Phase 4: Type System Modernization

- prefer jsforce types and contribute missing types (like category field) 
- Convert all remaining enums to string unions:
  - `TestLevel` enum in `src/tests/types.ts`
  - `TestCategory` and `TestCategoryPrefix` enums in `src/tests/types.ts`
  - `StreamingErrors` enum in `src/streaming/types.ts`
  - `logLevel` enum in `src/utils/types.ts`

## Phase 5: Message System Overhaul

- Replace current `i18n` system with sfdx-core/messages and ts-transformer (because all the other libraries do that)
- Update all message usage throughout codebase
- Remove existing `src/i18n/` implementation

## Phase 6: API Modernization

- Remove all barrel files (`index.ts` files in subdirectories)
- get rid of `reduce` usages (and if we are done with them, enable that eslint rule to prevent)
- Update imports to reference files directly
- Destructure public methods with multiple parameters:
  - `processApexTest` method in `testService.ts` (line 619-620)
  - Other methods identified during audit

## Phase 7: TraceFlag Cleanup & Export

- Clean up traceFlag functionality in `src/utils/traceFlags.ts`
- Export `ensureTraceFlags` function from main library
- Update extensions to use library version instead of duplicated code

## Phase 8: Effectify Everything - Replace Custom Telemetry with Effect/OTEL

- **Remove elapsedTime decorator** (`src/utils/elapsedTime.ts`) entirely
- **Remove @elapsedTime() decorators** from all methods across codebase (TestService, LogService, TraceFlags, etc.)
- **Convert all async operations to Effect** for proper telemetry span management
- **HEAP in dx-utils** have a single fn to capture heap info, so it's easily added to logging or telemetry (node only) 
- **Environment/config-based heap activation**: Use `SF_HEAP_MONITOR` env var
- **Make telemetry available beyond apex extension**: Use Effect/OTEL spans throughout
- **Convert major service classes to Effect**:
  - TestService methods
  - LogService operations  
  - TraceFlags operations
  - ExecuteService (before removal)
  - StreamingClient operations
- **Add proper span attributes and metrics** for all operations
- **Remove direct HeapMonitor.getInstance() calls** from all files

## Phase 9: Dependency Management

- Explore getting `Cancellation` from vscode instead of local implementation
- use fs.glob and drop that dep on fast-glob
- Use table from dx-utils package (that needs to be publicly packaged first).  Also consider whether ui table belongs in library code vs the consumer
- Use dev-scripts for dependency management

## Phase 10: Streaming Decision & Implementation

- Analyze current streaming API usage vs polling benefits
- Implement chosen approach (streaming or polling)
- if we **do** need streaming, can we
  - use the streaming api from jsforce directly? (or enhance it for whatever it's missing)
  - use the streaming api implementation from sfdx-core
  - use the streaming api implementation from the extensions?
- Update related functionality accordingly
- either way, store raw test result json in a test_run>class folder format (1 file per class) so it's easier to work with large data stuff 

## Phase 11: Make testService.ts More Functional

- Make `testService.ts` methods more functional, less mutation-based
- Remove side effects and improve immutability

## Phase 12: Comprehensive Testing Enhancement

- Analyze plugin NUT coverage gaps and create e2e tests using plugins-testkit against real orgs (e.g., dreamhouse)
- Create comprehensive snapshot tests for all reporters (HumanReporter, TapReporter, JUnitReporter, CoverageReporter)
- Expand existing snapshot test coverage beyond current writeResultFiles tests

## Migration Guide Documentation

### Breaking Changes Summary

- **Node.js**: Minimum version updated from 18.18.2 to 20.x
- **ExecuteService Removed**: Use jsforce `conn.tooling.executeAnonymous()` directly
- **TypeScript**: Updated to 2023 configuration standards
- **Enums**: All enums converted to string unions
- **Messages**: Replaced custom i18n system with sfdx-core/messages
- **Imports**: Removed barrel files - imports must reference files directly
- **API**: Public methods with multiple parameters now use destructured objects
- **TraceFlags**: `ensureTraceFlags` now exported from main library
- **Telemetry**: Replaced custom elapsedTime decorator with Effect/OTEL spans
- **Heap Monitoring**: Integrated with Effect-based telemetry system

### Migration Steps for Consumers

Create a migration doc (v8>v9) like other libraries usually done with a summary of breaking changes and some example code
